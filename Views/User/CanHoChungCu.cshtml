@model IEnumerable<QuanLyPhongTro.Models.ViewModels.PhongTroVM>
@{
    ViewBag.Title = "Căn hộ chung cư";
    var active = "chungcu"; // để tô tab
}
@functions{
    string FormatGia(decimal? vnd)
    {
        if (!vnd.HasValue || vnd <= 0) return "Thoả thuận";
        var trieu = vnd.Value / 1_000_000m;
        return trieu >= 1 ? trieu.ToString("0.#") + " triệu/tháng"
                          : string.Format("{0:#,0} đ/tháng", vnd);
    }
    // Diện tích: double?
    string FormatDt(double? m2)
    {
        return m2.HasValue ? m2.Value.ToString("0.#") + " m²" : "-- m²";
    }
    // Sao theo CapDo
    IHtmlString Stars(int? cap)
    {
        int n = Math.Max(0, Math.Min(cap ?? 0, 5));
        return new HtmlString(new string('★', n) + new string('☆', 5 - n));
    }
    string Trunc(string s, int max)
    {
        if (string.IsNullOrWhiteSpace(s)) return "";
        return s.Length <= max ? s : s.Substring(0, max) + "…";
    }
    string Img(string u) => string.IsNullOrWhiteSpace(u)
    ? Url.Content("~/Assets/Images/no-image.png")
    : Url.Content(u);
    string Phone(string s)
    {
        if (string.IsNullOrWhiteSpace(s)) return "";
        return s.Length <= 4 ? s : new string('•', Math.Max(0, s.Length - 4)) + s.Substring(s.Length - 4);
    }
}

<style>
    .pt-wrap{max-width:1040px;margin:auto}
    .tabline{display:flex;gap:18px;border-bottom:1px solid #eee;margin:4px 0 16px}
    .tabline a{padding:10px 6px;font-weight:700;color:#666;text-decoration:none}
    .tabline a.active{color:#e03;position:relative}
    .tabline a.active:after{content:"";position:absolute;left:0;right:0;bottom:-1px;height:3px;background:#e03}

    .pt-card{display:flex;gap:16px;background:#fff;border:1px solid #eee;border-radius:12px;padding:14px}
    .pt-card + .pt-card{margin-top:14px}
    .pt-thumb{width:245px;height:180px;border-radius:10px;object-fit:cover;flex:0 0 auto;position:relative}
    .pt-thumb .count{position:absolute;left:10px;bottom:10px;background:rgba(0,0,0,.55);color:#fff;
                     font-size:.85rem;border-radius:18px;padding:2px 8px}
    .pt-title{font-weight:800;color:#e03;line-height:1.28;margin-bottom:6px;text-transform:none}
    .pt-meta{display:flex;flex-wrap:wrap;gap:12px;color:#5f6b7a;margin-bottom:6px}
    .pt-meta .price{color:#0aa95b;font-weight:800}
    .pt-desc{color:#445566;font-size:.95rem;margin:.25rem 0 .5rem}
    .vip-stars{color:#ffb703;margin-right:6px}
    .owner{display:flex;align-items:center;gap:10px;color:#536273}
    .owner .avatar{width:34px;height:34px;border-radius:50%;background:#eef3f7;display:inline-block}
    @@media (max-width:768px){
        .pt-card{flex-direction:column}
        .pt-thumb{width:100%;height:220px}
    }
</style>

<div class="pt-wrap">
    <div class="tabline">
        <a class="@(active=="chungcu"?"active":"")" href="@Url.Action("CanHoChungCu","User")">Căn hộ chung cư</a>
        <a class="@(active=="mini"?"active":"")" href="@Url.Action("CanHoMini","User")">Căn hộ mini</a>
    </div>

    @foreach (var p in Model)
    {
        var detailUrl = Url.Action("ChiTiet", "User", new { id = p.Id }); // có thể null nếu chưa tạo action, không lỗi
        var count = (p.Album?.Count ?? 0);
        <article class="pt-card shadow-sm">
            <a href="@detailUrl" style="position:relative;display:inline-block">
                <img class="pt-thumb" src="@Img(p.AnhDaiDien)" alt="@p.Ten"
                     onerror="this.onerror=null;this.src='@Url.Content("~/Assets/Images/no-image.png")';">
               
            </a>

            <div style="flex:1">
                <a class="text-decoration-none" href="@detailUrl">
                    <div class="pt-title">
                        @Stars(p.LoaiTinCapDo) @p.Ten
                    </div>
                </a>

                <div class="pt-meta">
                    <div class="price">@FormatGia(p.Gia)</div>
                    <div>
                        •@FormatDt(p.DienTich.HasValue ? (double?)Convert.ToDouble(p.DienTich.Value) : null)
                    </div>
                    <div>• @p.KhuVuc</div>
                </div>

                @if (!string.IsNullOrWhiteSpace(p.MoTaTomTat))
                {
                    <div class="pt-desc">@Trunc(p.MoTaTomTat, 150)</div>
                }

                <div class="owner">
                    <span class="avatar"></span>
                    <div>
                        <div class="fw-semibold">@(!string.IsNullOrWhiteSpace(p.ChuNha) ? p.ChuNha : "Người đăng")</div>
                        <div class="small text-muted">@p.NgayDang?.ToString("HH:mm dd/MM/yyyy") • @Phone(p.SoDienThoai)</div>
                    </div>

                    <div class="ms-auto">
                        <a class="btn btn-success btn-sm" href="@detailUrl">Liên hệ / Xem chi tiết</a>
                    </div>
                </div>
            </div>
        </article>
    }

    @* Phân trang (nếu bạn đã set ViewBag.Page, PageSize, Total) *@
    @{
        int page = ViewBag.Page ?? 1;
        int pageSize = ViewBag.PageSize ?? 10;
        int total = ViewBag.Total ?? 0;
        int totalPages = (int)Math.Ceiling(total / (double)pageSize);
    }
    @if (totalPages > 1)
    {
        <nav class="mt-3">
            <ul class="pagination">
                <li class="page-item @(page==1?"disabled":"")">
                    <a class="page-link" href="@Url.Action("CanHoChungCu","User", new { page = page-1, pageSize })">«</a>
                </li>
                @for (int i = Math.Max(1, page - 2); i <= Math.Min(totalPages, page + 2); i++)
                {
                    <li class="page-item @(i==page?"active":"")">
                        <a class="page-link" href="@Url.Action("CanHoChungCu","User", new { page = i, pageSize })">@i</a>
                    </li>
                }
                <li class="page-item @(page==totalPages?"disabled":"")">
                    <a class="page-link" href="@Url.Action("CanHoChungCu","User", new { page = page+1, pageSize })">»</a>
                </li>
            </ul>
        </nav>
    }
</div>
