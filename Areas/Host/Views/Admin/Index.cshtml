@model QuanLyPhongTro.Areas.Admin.ChuNhaViewModels.ChuNha

@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/Host/Views/Shared/_Layout.cshtml";
}

@using (Html.BeginForm("SavePost", "Admin", FormMethod.Post, new { enctype = "multipart/form-data" }))
    {
    @Html.AntiForgeryToken()
    <!-- HỘP THÔNG BÁO -->
    <div id="notifyBox" class="notify hidden">
        <div class="notify-header">
            <span class="notify-title">Vui lòng nhập đủ thông tin</span>
            <button type="button" id="notifyClose" class="notify-close">&times;</button>
        </div>
        <div class="notify-body">
            <ul id="notifyList"></ul>
        </div>
    </div>
    <div class="container-fluid py-3">
        <div class="post-sticky-wrap">
            <h3 class="section-title">Đăng tin cho thuê</h3>
            <nav class="section-nav" id="postNav">
                <a href="#khuvuc" class="active">Khu vực</a>
                <a href="#mota">Thông tin mô tả</a>
                <a href="#hinhanh">Hình ảnh</a>
                <a href="#video">Video</a>
                <a href="#lienhe">Thông tin liên hệ</a>
            </nav>
        </div>
        <div style="width:100%; display:flex;">
            <div style="width:15%; display:block;"></div>
            <div style="width:70%">
                <!-- ===== LOẠI CHUYÊN MỤC ===== -->
                <div class="card p-4" id="loaitin">
                    <h5 class="mb-3">Chuyên mục và loại tin</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Loại chuyên mục <span class="text-danger">*</span></label>
                            <select class="form-select" name="ID_CD">
                                <option selected disabled>-- Chọn loại chuyên mục --</option>
                                <option value="4">Phòng Trọ</option>
                                <option value="5">Nhà ở mini</option>
                                <option value="6">Căng hộ chung cư</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Loại chuyên mục <span class="text-danger">*</span></label>
                            <select id="LoaiTinSelect" name="ID_LoaiTin" class="form-select">
                                <option selected disabled>-- Chọn loại loại tin --</option>
                                @foreach (var item in Model.LoaiTin)
                                    {
                                    <option value="@item.ID_LoaiTin">@item.Ten_LoaiTin</option>
                                    }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Thời Gian</label>
                            <select id="ThoiGianSelect" class="form-select" name="ID_Gia">
                                <option selected disabled>-- Chọn thời gian --</option>
                            </select>
                            <span id="GhiChu" style="margin-left:10px;color:gray;"></span>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Lựa chọn ngày</label>
                            <input type="number" id="NgayInput" name="Ngay" class="form-control" placeholder="Nhập số ngày" />
                            <small id="NgayWarning" style="color:red; display:none;">Số ngày phải là bội của 3</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Bảng giá</label>
                            <input type="number" name="BangGia" id="banggia" class="form-control" placeholder="" readonly />
                        </div>
                    </div>
                </div>

                <!-- ===== KHU VỰC ===== -->
                <div class="card p-4" id="khuvuc">
                    <h5 class="mb-4">Khu vực</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Phường/Xã</label>
                            <select class="form-select" name="ID_KV">
                                <option selected disabled>-- Chọn phường/xã --</option>
                                @foreach (var item in Model.KhuVuc)
                                    {
                                    <option value="@item.ID_KV">@item.Ten_KV</option>
                                    }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Địa chỉ</label>
                            <input id="DiaChi" name="DiaChi" type="text" class="form-control bg-light" placeholder="Ghi đúng địa chỉ của bạn" />
                        </div>
                    </div>
                </div>

                <!-- ===== THÔNG TIN MÔ TẢ ===== -->
                <div class="card p-4" id="mota">
                    <h5 class="mb-4">Thông tin mô tả</h5>

                    <div class="mb-3">
                        <label class="form-label">Tiêu đề <span class="text-danger">*</span></label>
                        <input type="text" name="TieuDe" class="form-control" placeholder="Nhập tiêu đề bài đăng" />
                        <div class="text-muted mt-1">(Tối thiểu 30 ký tự, tối đa 100 ký tự)</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Nội dung mô tả <span class="text-danger">*</span></label>
                        <textarea name="MoTa" class="form-control" rows="6" placeholder="Nhập nội dung mô tả chi tiết..." style="height:400px !important;"></textarea>
                        <div class="text-muted mt-1">(Tối thiểu 50 ký tự, tối đa 5000 ký tự)</div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Giá cho thuê<span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" name="GiaThue" class="form-control" placeholder="Ví dụ: 3000000" />
                                <select class="form-select" style="max-width: 160px;">
                                    <option>đồng/tháng</option>

                                </select>
                            </div>
                            <div class="text-muted mt-1">Nhập đầy đủ số, ví dụ 1 triệu thì nhập 1000000</div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Diện tích <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" name="DienTich" class="form-control" placeholder="Nhập diện tích" />
                                <span class="input-group-text">m²</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ===== ĐẶC ĐIỂM NỔI BẬT ===== -->
                <div class="card p-4">
                    <h5 class="mb-3">Đặc điểm nổi bật</h5>
                    <div class="row checkbox-grid">
                        <div class="col-md-4">
                            <div><input type="checkbox" name="DayDuNoiThat" value="true" /> Đầy đủ nội thất</div>
                            <div><input type="checkbox" name="CoMayLanh" value="true" /> Có máy lạnh</div>
                            <div><input type="checkbox" name="CoThangMay" value="true" /> Có thang máy</div>
                            <div><input type="checkbox" name="CoBaoVe" value="true" /> Có bảo vệ 24/24</div>
                        </div>
                        <div class="col-md-4">
                            <div><input type="checkbox" name="CoGac" value="true" /> Có gác</div>
                            <div><input type="checkbox" name="CoMayGiat" value="true" /> Có máy giặt</div>
                            <div><input type="checkbox" name="KhongChungChu" value="true" /> Không chung chủ</div>

                        </div>
                        <div class="col-md-4">
                            <div><input type="checkbox" name="CoKeBep" value="true" /> Có kệ bếp</div>
                            <div><input type="checkbox" name="CoTuLanh" value="true" /> Có tủ lạnh</div>
                            <div><input type="checkbox" name="GioGiacTuDo" value="true" /> Giờ giấc tự do</div>
                        </div>
                    </div>
                </div>


                <!-- ====== HÌNH ẢNH ====== -->
                <section id="hinhanh">
                    <div class="card p-4">
                        <h5 class="mb-3">Hình ảnh</h5>

                        <div class="upload-area text-center py-5" id="imageUploadBox">
                            <i class="bi bi-camera fs-1 text-primary mb-2"></i>
                            <p class="fw-semibold mb-0">Tải ảnh từ thiết bị</p>
                            <input type="file" id="imageInput" name="imageInput" accept="image/*" multiple hidden />
                        </div>

                        <ul class="mt-3 note">
                            <li>Tải lên tối đa 20 ảnh trong một bài đăng</li>
                            <li>Dung lượng ảnh tối đa 10MB</li>
                            <li>Hình ảnh phải liên quan đến phòng trọ, nhà cho thuê</li>
                            <li>Không chèn văn bản, số điện thoại lên ảnh</li>
                        </ul>

                        <!-- Khung hiển thị ảnh preview -->
                        <div class="preview-area mt-3 d-flex flex-wrap gap-2" id="imagePreview"></div>
                    </div>
                </section>

                <!-- ====== VIDEO ====== -->
                <section id="video">
                    <div class="card p-4">
                        <h5 class="mb-3">Video</h5>

                        <label class="form-label">Video Link (Youtube/Tiktok)</label>
                        <input type="file" id="videoInput" name="videoInput" accept="video/*" hidden />
                        <div class="note mb-3">
                            <b>Lưu ý:</b> Bạn có thể chọn video từ Youtube hoặc Tiktok để hiển thị trên bài viết của mình.<br>
                        </div>

                        <div class="upload-area text-center py-5" id="videoUploadBox">
                            <i class="bi bi-camera-video fs-1 text-primary mb-2"></i>
                            <p class="fw-semibold mb-0">Tải video từ thiết bị</p>
                            <input type="file" id="videoInput" name="videoInput" accept="video/*" hidden />
                        </div>

                        <!-- Preview video -->
                        <div class="preview-area mt-3" id="videoPreview"></div>
                    </div>
                </section>
                <!-- ===== THÔNG TIN LIÊN HỆ ===== -->
                <div class="card p-4" id="lienhe">
                    <h5 class="mb-3">Thông tin liên hệ</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Họ và tên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" value="@ViewBag.SDT" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" value="@ViewBag.Name" readonly />
                        </div>
                    </div>
                </div>

                <!-- ===== NÚT ĐĂNG ===== -->
                <div class="text-center mt-4 mb-5" style="padding-top:50px">
                    <button class="btn btn-primary px-5 py-2 fw-semibold rounded-pill">
                        <i class="bi bi-check-circle me-2"></i> Đăng tin ngay
                    </button>
                </div>
            </div>
            <div style="width:15%; display:block;"></div>
        </div>



    </div>
    }
<hr />
<div>
    @Html.Partial("_Footer")
</div>


<script>
document.addEventListener("DOMContentLoaded", function () {

    /* =====================================================
       📸 1. UPLOAD ẢNH
    ===================================================== */
    const imageBox = document.getElementById("imageUploadBox");
    const imageInput = document.getElementById("imageInput");
    const imagePreview = document.getElementById("imagePreview");

    if (imageBox && imageInput && imagePreview) {
        imageBox.addEventListener("click", () => imageInput.click());

        imageInput.addEventListener("change", () => {
            const files = Array.from(imageInput.files);

            // đếm tổng: ảnh cũ + ảnh mới đang chọn
            const oldCount = imagePreview.querySelectorAll("input[name='OldImages']").length;
            if (oldCount + files.length > 20) {
                alert("⚠️ Tối đa 20 ảnh (gồm cả ảnh cũ và ảnh mới).");
                imageInput.value = "";
                return;
            }

            files.forEach(file => {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`Ảnh "${file.name}" vượt quá 10MB, vui lòng chọn ảnh khác.`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = e => {
                    // tạo wrapper giống ảnh cũ
                    const wrap = document.createElement("div");
                    wrap.style.position = "relative";
                    wrap.style.display = "inline-block";
                    wrap.style.marginRight = "6px";

                    const img = document.createElement("img");
                    img.src = e.target.result;
                    img.style.width = "120px";
                    img.style.height = "120px";
                    img.style.objectFit = "cover";
                    img.style.borderRadius = "10px";
                    img.style.border = "1px solid #ddd";

                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "btn btn-sm btn-danger";
                    btn.style.position = "absolute";
                    btn.style.top = "3px";
                    btn.style.right = "3px";
                    btn.innerHTML = '<i class="bi bi-x"></i>';

                    // xoá ảnh mới
                    btn.addEventListener("click", () => {
                        wrap.remove();

                        // nếu bạn muốn reset input khi xoá hết ảnh mới:
                        const stillNew = imagePreview.querySelectorAll(".new-upload-img").length;
                        if (stillNew === 0) {
                            imageInput.value = "";
                        }
                    });

                    // đánh dấu đây là ảnh mới (để đếm / xử lý sau)
                    img.classList.add("new-upload-img");

                    wrap.appendChild(img);
                    wrap.appendChild(btn);
                    imagePreview.appendChild(wrap);
                };
                reader.readAsDataURL(file);
            });
        });
    }

    /* =====================================================
       🎥 2. UPLOAD VIDEO
    ===================================================== */
    const videoBox = document.getElementById("videoUploadBox");
    const videoInput = document.getElementById("videoInput");
    const videoPreview = document.getElementById("videoPreview");

    if (videoBox && videoInput && videoPreview) {
        videoBox.addEventListener("click", () => videoInput.click());

        videoInput.addEventListener("change", () => {
            const file = videoInput.files[0];
            if (!file) return;

            if (file.size > 50 * 1024 * 1024) {
                alert("⚠️ Dung lượng video vượt quá 50MB, vui lòng chọn video nhỏ hơn.");
                videoInput.value = "";
                return;
            }

            // tạo wrapper giống ảnh cũ
            const wrap = document.createElement("div");
            wrap.style.position = "relative";
            wrap.style.display = "inline-block";
            wrap.style.marginRight = "10px";

            const url = URL.createObjectURL(file);
            const video = document.createElement("video");
            video.src = url;
            video.controls = true;
            video.width = 200;
            video.height = 130;
            video.style.borderRadius = "10px";
            video.style.border = "1px solid #ddd";
            // đánh dấu là video mới
            video.classList.add("new-upload-video");

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "btn btn-sm btn-danger";
            btn.style.position = "absolute";
            btn.style.top = "3px";
            btn.style.right = "3px";
            btn.innerHTML = '<i class="bi bi-x"></i>';

            btn.addEventListener("click", () => {
                wrap.remove();
                // nếu muốn reset input khi xoá video mới
                videoInput.value = "";
            });

            wrap.appendChild(video);
            wrap.appendChild(btn);
            videoPreview.appendChild(wrap);
        });
    }

    /* =====================================================
       🧭 3. NAV CUỘN MƯỢT
    ===================================================== */
    const navLinks = Array.from(document.querySelectorAll('#postNav a'));
    const sections = navLinks.map(a => document.querySelector(a.getAttribute('href')));
    let scrolling = false;

    function setActive(hash) {
        navLinks.forEach(l => l.classList.toggle('active', l.getAttribute('href') === hash));
    }

    navLinks.forEach(a => {
        a.addEventListener('click', e => {
            e.preventDefault();
            const id = a.getAttribute('href');
            const section = document.querySelector(id);
            if (!section) return;

            scrolling = true;
            setActive(id);

            const offsetTop = section.getBoundingClientRect().top + window.scrollY - 100;
            window.scrollTo({ top: offsetTop, behavior: 'smooth' });

            setTimeout(() => scrolling = false, 800);
        });
    });

    function updateActiveOnScroll() {
        if (scrolling) return;
        let current = sections[0];
        let minDiff = Infinity;
        const viewportMid = window.scrollY + window.innerHeight / 3;

        sections.forEach(sec => {
            if (!sec) return;
            const offsetTop = sec.offsetTop;
            const diff = Math.abs(offsetTop - viewportMid);
            if (diff < minDiff) {
                minDiff = diff;
                current = sec;
            }
        });

        if (current) setActive('#' + current.id);
    }
    window.addEventListener('scroll', updateActiveOnScroll);
    updateActiveOnScroll();

    /* =====================================================
       4. KHAI BÁO CHUNG (dùng cho validate & dropdown)
    ===================================================== */
    // lấy bảng giá từ server
    var bangGiaTin     = @Html.Raw(Json.Encode(Model.BangGiaTin));

    // element
    var loaiTinSelect  = document.getElementById("LoaiTinSelect");
    var thoiGianSelect = document.getElementById("ThoiGianSelect");
    var ghiChuSpan     = document.getElementById("GhiChu");
    var ngayInput      = document.getElementById("NgayInput");
    var ngayWarning    = document.getElementById("NgayWarning");
    var bangGiaInput   = document.getElementById("banggia");

    // trạng thái dùng chung
    var currentGiaGiam  = 0;
    var currentTimeType = "ngay"; // "ngay" | "tuan" | "thang"

    // helper: lấy số đầu tiên trong ghi chú
    function extractMinDays(text) {
        if (!text) return null;
        var m = text.match(/\d+/);
        return m ? parseInt(m[0], 10) : null;
    }

    /* =====================================================
       5. VALIDATE FORM (alert) — dùng được currentTimeType
    ===================================================== */
    const form = document.querySelector("form");
    if (form) {
        form.addEventListener("submit", function (e) {
            const tieuDe    = document.querySelector("input[name='TieuDe']").value.trim();
            const moTa      = document.querySelector("textarea[name='MoTa']").value.trim();
            const giaThue   = document.querySelector("input[name='GiaThue']").value.trim();
            const dienTich  = document.querySelector("input[name='DienTich']").value.trim();
            const diaChi    = document.querySelector("input[name='DiaChi']").value.trim();
            const khuVuc    = document.querySelector("select[name='ID_KV']").value;
            const chuyenMuc = document.querySelector("select.form-select").value;
            const loaiTin   = document.getElementById("LoaiTinSelect")?.value || "";
            const thoiGian  = document.getElementById("ThoiGianSelect")?.value || "";
            const ngay      = document.getElementById("NgayInput")?.value || "";
            const bangGia   = document.getElementById("banggia")?.value || "";
            const anh       = document.querySelector("input[name='imageInput']")?.files.length || 0;

            let missing = [];

            // cũ
            if (!chuyenMuc) missing.push("Loại chuyên mục");
            if (!khuVuc) missing.push("Khu vực");
            if (!tieuDe) missing.push("Tiêu đề");
            if (!moTa) missing.push("Mô tả");
            if (!giaThue) missing.push("Giá thuê");
            if (!dienTich) missing.push("Diện tích");
            if (!diaChi) missing.push("Địa chỉ");
            if (anh === 0) missing.push("Ảnh");

            // mới
            if (!loaiTin)  missing.push("Loại tin");
            if (!thoiGian) missing.push("Thời gian");
            if (!ngay)     missing.push("Lựa chọn ngày");
            if (!bangGia)  missing.push("Bảng giá");

            // ❗ chỉ bắt bội của 3 khi đang là NGÀY
            if (currentTimeType === "ngay") {
                const ngayNum = parseInt(ngay, 10);
                if (ngay && (isNaN(ngayNum) || ngayNum % 3 !== 0)) {
                    missing.push("Số ngày phải là bội của 3");
                }
            }

            if (missing.length > 0) {
                e.preventDefault();

                const box = document.getElementById("notifyBox");
                const list = document.getElementById("notifyList");

                // xóa cũ
                list.innerHTML = "";

                // đổ lỗi
                missing.forEach(function (item) {
                    const li = document.createElement("li");
                    li.textContent = item;
                    list.appendChild(li);
                });

                // hiện hộp
                box.classList.remove("hidden");
                setTimeout(() => box.classList.add("hidden"), 5000);
                return;
            }

        });
    }

    /* =====================================================
       6. LOẠI TIN → THỜI GIAN → NGÀY + BẢNG GIÁ
    ===================================================== */

    // khi đổi LOẠI TIN
    if (loaiTinSelect) {
        loaiTinSelect.addEventListener("change", function () {
            var idLoaiTin = this.value;

            // reset
            thoiGianSelect.innerHTML = '<option selected disabled>-- Chọn thời gian --</option>';
            if (ghiChuSpan) ghiChuSpan.textContent = '';
            if (ngayInput) {
                ngayInput.value = '';
                ngayInput.readOnly = false;
                delete ngayInput.dataset.min;
            }
            if (ngayWarning) ngayWarning.style.display = 'none';
            if (bangGiaInput) bangGiaInput.value = '';
            currentGiaGiam  = 0;
            currentTimeType = "ngay";

            // lọc và đổ
            var list = bangGiaTin.filter(function (x) {
                return x.ID_LoaiTin == idLoaiTin;
            });

            list.forEach(function (item) {
                var opt = document.createElement("option");
                opt.value = item.ID_Gia;
                opt.textContent = item.Thoi_Gian;
                opt.dataset.ghichu  = item.Ghi_Chu  || '';
                opt.dataset.giagiam = item.Gia_Giam || 0;
                thoiGianSelect.appendChild(opt);
            });
        });
    }

    // khi chọn THỜI GIAN
    if (thoiGianSelect) {
        thoiGianSelect.addEventListener("change", function () {
            var opt = this.options[this.selectedIndex];
            if (!opt) return;

            var ghichu      = opt.dataset.ghichu || '';
            var giaGiam     = opt.dataset.giagiam ? parseFloat(opt.dataset.giagiam) : 0;
            var tenThoiGian = opt.textContent.toLowerCase();

            if (ghiChuSpan) ghiChuSpan.textContent = ghichu;

            currentGiaGiam = giaGiam;

            if (ngayWarning) ngayWarning.style.display = 'none';
            if (ngayInput) {
                ngayInput.value = '';
                ngayInput.readOnly = false;
                delete ngayInput.dataset.min;
            }

            if (bangGiaInput) bangGiaInput.value = giaGiam;

            if (tenThoiGian.includes('tuần')) {
                currentTimeType = "tuan";
                if (ngayInput) {
                    ngayInput.value = 7;
                    ngayInput.readOnly = true;
                }
            } else if (tenThoiGian.includes('tháng')) {
                currentTimeType = "thang";
                if (ngayInput) {
                    ngayInput.value = 30;
                    ngayInput.readOnly = true;
                }
            } else {
                currentTimeType = "ngay";
                if (ngayInput) {
                    ngayInput.readOnly = false;
                    var minDays = extractMinDays(ghichu);
                    if (minDays) {
                        ngayInput.dataset.min = minDays;
                    }
                }
            }
        });
    }

    // khi gõ SỐ NGÀY
    if (ngayInput) {
        ngayInput.addEventListener("input", function () {
            var val = this.value ? parseInt(this.value, 10) : 0;

            if (currentTimeType === "ngay") {
                // bắt buộc bội của 3
                if (val > 0 && val % 3 !== 0) {
                    if (ngayWarning) ngayWarning.style.display = 'block';
                    if (bangGiaInput) bangGiaInput.value = '';
                    return;
                } else {
                    if (ngayWarning) ngayWarning.style.display = 'none';
                }

                // đúng bội 3 thì tính tiền
                if (bangGiaInput) {
                    if (val > 0) {
                        var soBo = val / 3;
                        bangGiaInput.value = currentGiaGiam * soBo;
                    } else {
                        bangGiaInput.value = '';
                    }
                }
            } else {
                // tuần / tháng -> không kiểm tra bội 3
                if (ngayWarning) ngayWarning.style.display = 'none';
                // giá đã set khi chọn thời gian
            }
        });
    }

});
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const closeBtn = document.getElementById("notifyClose");
        const box = document.getElementById("notifyBox");
        if (closeBtn && box) {
            closeBtn.addEventListener("click", function () {
                box.classList.add("hidden");
            });
        }
    });
</script>
<script>
    function removeOldImage(imgName, btn) {
        if (!confirm("Bạn có chắc muốn xóa ảnh này không?")) return;

        const wrapper = btn.closest("div");
        if (wrapper) wrapper.remove();

        const input = document.querySelector("input[name='OldImages'][value='" + imgName + "']");
        if (input) input.remove();
    }

    function removeOldVideo(videoName, btn) {
        if (!confirm("Xóa video này?")) return;

        const wrapper = btn.closest("div");
        if (wrapper) wrapper.remove();

        const hidden = document.querySelector("input[name='OldVideos'][value='" + videoName + "']");
        if (hidden) hidden.remove();
    }
</script>



